import pandas as pd
import numpy as np

def find_auc(y, pred):
    fpr, tpr, threshholds = metrics.roc_curve(y, predictions, pos_label = 1)
    print(metrics.auc(fpr, tpr))

def create_submission(model, df):
    to_return = pd.DataFrame(columns=['MachineIdentifier','HasDetections'])
    mid = df['MachineIdentifier']
    df.drop('MachineIdentifier', axis=1, inplace=True)
    prediction = model.predict(df)
    to_return['MachineIdentifier'] = mid
    to_return['HasDetections'] = prediction
    return to_return

def expand_df(df, variable):
    var_dumm = pd.get_dummies(df[variable])
    df.drop(variable, axis=1, inplace=True)
    return pd.concat([df, var_dumm], axis= 1)

def export_to_csv(df):
    df.to_csv(EXPORT_PATH, index=None, header=True)

def display_values(df, attribute): 
    print(df[attribute].value_counts(dropna=False))

#this cells code was borrow from Ken's github 
#https://github.com/kfarr3/Kaggle-MS-Malware-Prediction-2019/blob/master/code/1%20-%20Explore%20Data.ipynb
def split_versions(df, column):
    new_columns = [column + part for part in ['Major', 'Minor', 'Build', 'Revision']]
    df[new_columns] = df[column].str.split('.', expand=True)
    df.drop(column, inplace=True, axis=1)
    return df

def fill_in_missing(df, attribute, value):
    return df[attribute].fillna(value, inplace=True)

def clean_data_general(train_df):
    missing_int_values = ['RtpStateBitfield', 'DefaultBrowsersIdentifier', 'AVProductStatesIdentifier', 'AVProductsInstalled', 'AVProductsEnabled', 'CityIdentifier', 'OrganizationIdentifier', 'GeoNameIdentifier', 'IsProtected', 'SMode', 'IeVerIdentifier', 'Firewall', 'UacLuaenable', 'Census_OEMNameIdentifier', 'Census_ProcessorCoreCount','Census_ProcessorManufacturerIdentifier','Census_ProcessorModelIdentifier', 'Census_PrimaryDiskTotalCapacity', 'Census_TotalPhysicalRAM', 'Census_PrimaryDiskTotalCapacity', 'Census_InternalPrimaryDiagonalDisplaySizeInInches', 'Census_InternalPrimaryDisplayResolutionHorizontal', 'Census_InternalPrimaryDisplayResolutionVertical', 'Census_InternalBatteryNumberOfCharges', 'Census_OSInstallLanguageIdentifier', 'Census_IsFlightingInternal', 'Census_IsFlightsDisabled', 'Census_ThresholdOptIn', 'Census_FirmwareManufacturerIdentifier', 'Census_FirmwareVersionIdentifier', 'Census_IsWIMBootEnabled', 'Census_IsVirtualDevice', 'Census_IsAlwaysOnAlwaysConnectedCapable', 'Wdft_IsGamer', 'Wdft_RegionIdentifier']
    missing_expand = ['PuaMode', 'SmartScreen', 'Census_ProcessorClass', 'Census_PrimaryDiskTypeName', 'Census_PowerPlatformRoleName']
    missing_needs_more_work = ['OsBuildLab','Census_OEMModelIdentifier','Census_SystemVolumeTotalCapacity','Census_ChassisTypeName','Census_InternalBatteryType']
    drop_col_for_now = ['Census_MDC2FormFactor', 'SkuEdition', 'Census_OSBranch', 'Census_OSEdition', 'Census_OSSkuName', 'Census_OSInstallTypeName', 'Census_ActivationChannel', 'Census_FlightRing']
    expand = ['ProductName', 'Platform', 'Processor', 'OsPlatformSubRelease', 'Census_DeviceFamily', 'Census_OSArchitecture', 'Census_OSWUAutoUpdateOptionsName', 'Census_GenuineStateName']
    
    #drop all of the culumns that are null that we are not trying to add in yet.
    train_df.drop(columns=missing_int_values, inplace=True)
    train_df.drop(columns=missing_needs_more_work, inplace=True)
    #train_df.drop(columns=missing_expand, inplace=True)
    train_df.drop(columns = drop_col_for_now, inplace = True)
    
    for column in expand:
        print('Expanding', column)
        train_df = expand_df(train_df, column)
    
    #this code was borrowed from Ken's GitHub 
    #https://github.com/kfarr3/Kaggle-MS-Malware-Prediction-2019/blob/master/code/1%20-%20Explore%20Data.ipynb

    # thinking the best way to handle this is to do a AppVersionMajor, AppVersionMinor, AppVersionBuild, AppVersionRevision
    for column in ['OsVer', 'EngineVersion', 'AppVersion', 'Census_OSVersion', 'AvSigVersion']:
        print("Expanding version", column)
        train_df = split_versions(train_df, column)
    
    # now we need to convert objects to ints where appropriate
    for column in train_df.dtypes[train_df.dtypes==object].index:
        print("Converting to int column ",column)
        train_df[column] = train_df[column].astype(int, errors='ignore')
        
    #had to drop AvSigVersionMinor becuase it is still an object
    train_df.drop('AvSigVersionMinor', axis=1, inplace=True)
    
    
    train_df.fillna("Not a Number", inplace=True)
    for column in missing_expand:
        print('Expanding missing column', column)
        train_df = expand_df(train_df, column)
    
    return train_df
